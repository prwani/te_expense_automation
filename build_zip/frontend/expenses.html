<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Manage Expenses</title>
<link rel="stylesheet" href="/static/assets/style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="header-bar">
      <div class="header-left">
        <div class="brand">Travel Expense Automation</div>
        <nav class="nav-inline">
          <a href="index.html">Untagged Expenses</a>
          <a href="tagged-expenses.html">Tagged Expenses</a>
          <a class="active" href="expenses.html">Manage Expenses</a>
          <a href="reports.html">Expense Reports</a>
        </nav>
      </div>
      <div class="header-right">
        <div class="theme-toggle" id="theme-toggle" title="Toggle Theme">üåó</div>
      </div>
    </header>
    <section class="card fade-in" style="margin-top:1.3rem;">
      <div class="section-hint">Manage</div>
      <h1 style="margin-top:0; font-size:1.2rem;">Expense Table</h1>
      <div class="toolbar" style="margin-bottom:.4rem;">
        <button id="add-row" class="primary">Add Row</button>
        <button id="save-all" disabled class="primary">Save Changes</button>
        <button id="reload">Reload</button>
        <span id="dirty-indicator" class="badge warning" style="display:none;">Unsaved</span>
        <div class="spacer"></div>
        <a href="index.html" class="btn outline small" style="text-decoration:none;">‚Üê Back</a>
      </div>
      <div class="table-wrap"><div class="table-responsive">
      <table id="expenses-table" class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Category</th>
            <th>Merchant</th>
            <th>Amount</th>
            <th>Amount (INR)</th>
            <th>Project ID</th>
            <th>Billable</th>
            <th>Payment</th>
            <th>Receipts?</th>
            <th>Tagged</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table></div></div>
      <div class="small muted" id="status" style="margin-top:.6rem;"></div>
    </section>
    <footer class="app-footer">Built with FastAPI + Vanilla JS UI ‚Ä¢ <span id="year"></span></footer>
  </div>
<script>
const __origin = window.location.origin;
const API_BASE = (__origin && __origin !== 'null') ? __origin : 'http://localhost:8000';
const rootBody = document.body; const savedTheme = localStorage.getItem('app-theme'); if(savedTheme){ rootBody.setAttribute('data-theme', savedTheme);} document.getElementById('theme-toggle').addEventListener('click', ()=>{ const cur = rootBody.getAttribute('data-theme')==='dark' ? 'light':'dark'; if(cur==='light') rootBody.removeAttribute('data-theme'); else rootBody.setAttribute('data-theme','dark'); localStorage.setItem('app-theme', cur==='light'? '' : 'dark');}); document.getElementById('year').textContent = new Date().getFullYear();
let originalData = [];
let workingData = [];

function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k === 'class') e.className = v; else if(k.startsWith('on') && typeof v === 'function') e.addEventListener(k.substring(2), v); else e.setAttribute(k,v);
  });
  children.forEach(c=>{ if(c!==null && c!==undefined) e.appendChild(typeof c === 'string'? document.createTextNode(c): c); });
  return e;
}

function markDirty(){
  document.getElementById('dirty-indicator').style.display='inline';
  document.getElementById('save-all').disabled = false;
}

function computeRowState(row){
  if(!row.id) return 'new-row';
  const original = originalData.find(o=>o.id===row.id);
  if(original){
    for(const k of Object.keys(row)){
      if(k==='__state' || k==='id') continue;
      if(row[k] !== original[k]) return 'modified';
    }
  }
  if(row.__duplicated) return 'duplicate';
  return '';
}

function renderTable(){
  const tbody = document.querySelector('#expenses-table tbody');
  tbody.innerHTML='';
  workingData.forEach((row, idx)=>{
    const tr = document.createElement('tr');
    const stateClass = computeRowState(row);
    if(stateClass) tr.classList.add(stateClass);

    function editableCell(field, type='text'){
      const td = document.createElement('td');
      if(field==='id'){
        td.textContent = row.id ? row.id : '(new)';
        td.style.fontStyle = row.id ? 'normal' : 'italic';
        return td;
      }
      if(type==='checkbox'){
        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.checked = !!row[field];
        cb.addEventListener('change',()=>{ row[field]= cb.checked?1:0; markDirty(); renderTable(); });
        td.appendChild(cb);
        return td;
      }
  const input = document.createElement('input');
      input.type=type;
      input.value = row[field] ?? '';
      if(type==='number') input.step='0.01';
      if(field==='date') input.classList.add('date');
      input.addEventListener('change',()=>{ 
        if(type==='number') row[field] = parseFloat(input.value)||0; else row[field]= input.value; 
        markDirty();
        renderTable();
      });
      td.appendChild(input);
      return td;
    }

    tr.appendChild(editableCell('id'));
    tr.appendChild(editableCell('date'));
    tr.appendChild(editableCell('category'));
    tr.appendChild(editableCell('merchant'));
    tr.appendChild(editableCell('amount','number'));
    tr.appendChild(editableCell('amount_in_inr','number'));
    tr.appendChild(editableCell('project_id'));
    tr.appendChild(editableCell('billable','checkbox'));
    tr.appendChild(editableCell('payment_method'));
  tr.appendChild(editableCell('receipts_attached','checkbox'));
  tr.appendChild(editableCell('tagged','checkbox'));

    const actionsTd = document.createElement('td');
    actionsTd.className='actions-col';
  const dupBtn = el('button',{onclick:()=>{ duplicateRow(idx); }, class:'outline'},'Duplicate');
  const delBtn = el('button',{onclick:()=>{ deleteRow(idx); }, class:'danger'},'Delete');
    actionsTd.appendChild(dupBtn);
    actionsTd.appendChild(delBtn);
    tr.appendChild(actionsTd);

    tbody.appendChild(tr);
  });
}

async function loadExpenses(){
  setStatus('Loading...');
  const res = await fetch(`${API_BASE}/expenses/`);
  const data = await res.json();
  originalData = JSON.parse(JSON.stringify(data));
  workingData = JSON.parse(JSON.stringify(data));
  renderTable();
  clearDirty();
  setStatus(`Loaded ${data.length} expenses.`);
}

function clearDirty(){
  document.getElementById('dirty-indicator').style.display='none';
  document.getElementById('save-all').disabled = true;
}

function addRow(){
  const newRow = { id: null, date: new Date().toISOString().slice(0,10), category:'', merchant:'', amount:0, amount_in_inr:0, project_id:'0', billable:0, payment_method:'', receipts_attached:0, tagged:0 };
  workingData.unshift(newRow);
  markDirty();
  renderTable();
}

function duplicateRow(idx){
  const source = workingData[idx];
  const clone = { ...source, id: null };
  clone.__duplicated = true;
  workingData.splice(idx+1,0,clone);
  markDirty();
  renderTable();
}

function deleteRow(idx){
  const row = workingData[idx];
  if(row && row.id){
    // call backend delete
    fetch(`${API_BASE}/expenses/${row.id}`, { method:'DELETE' })
      .then(r=>{
        if(!r.ok){ throw new Error('Delete failed'); }
        // Remove from originalData too so it doesn't reappear after save/reload cycle until we fetch again
        originalData = originalData.filter(o=>o.id !== row.id);
        workingData.splice(idx,1);
        setStatus(`Deleted expense ${row.id}`);
        renderTable();
      })
      .catch(err=>{ setStatus(err.message); });
  } else {
    workingData.splice(idx,1);
    renderTable();
  }
}

async function saveAll(){
  setStatus('Saving...');
  const changed = workingData.filter(r=> !r.id || computeRowState(r) !== '');
  // Prepare payload; exclude helper props
  const payload = changed.map(r=>{
    const copy = {...r};
    delete copy.__duplicated; delete copy.__state; if(copy.id===null) delete copy.id; return copy; });
  const res = await fetch(`${API_BASE}/expenses/bulk`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok){ setStatus('Save failed'); return; }
  await loadExpenses();
  setStatus('Saved successfully');
}

function setStatus(msg){ document.getElementById('status').textContent = msg; }

// Event bindings
 document.getElementById('add-row').addEventListener('click', addRow);
 document.getElementById('save-all').addEventListener('click', saveAll);
 document.getElementById('reload').addEventListener('click', loadExpenses);

loadExpenses();
</script>
</body>
</html>
