<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Travel Expenses</title>
  <link rel="stylesheet" href="/static/assets/style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="header-bar">
      <div class="header-left">
        <div class="brand">Travel Expense Automation</div>
        <nav class="nav-inline">
          <a class="active" href="index.html">Untagged Expenses</a>
          <a href="tagged-expenses.html">Tagged Expenses</a>
          <a href="expenses.html">Manage Expenses</a>
          <a href="reports.html">Expense Reports</a>
        </nav>
      </div>
      <div class="header-right">
        <div class="theme-toggle" id="theme-toggle" title="Toggle Theme">üåó</div>
        <div id="settings-toggle" title="Settings">‚öôÔ∏è</div>
      </div>
    </header>
    <div id="settings-panel" class="settings-floating fade-in" style="display:none; position:fixed; top:70px; right:30px; width:300px; padding:14px 16px;">
      <h3 style="margin:0 0 10px; font-size:15px; font-weight:600; letter-spacing:.4px;">Settings</h3>
      <label class="small" style="display:block; margin-bottom:10px;">Database
        <select id="db-select" title="Database selection (Cosmos DB coming soon)">
          <option value="sqlite" selected>SQLite (Local)</option>
          <option value="cosmos_sql" disabled title="Cosmos DB support coming soon">Azure Cosmos DB (SQL API) ‚Äî coming soon</option>
        </select>
        <span class="muted" style="display:block; margin-top:4px;">Cosmos DB support is coming soon.</span>
      </label>
      <label class="small" style="display:block; margin-bottom:12px;">Processing Engine
        <select id="provider">
            <option value="document_intelligence">Document Intelligence</option>
            <option value="content_understanding">Content Understanding</option>
            <option value="gpt5_nano">Azure OpenAI (gpt-5-nano)</option>
            <option value="fallback">Heuristic Fallback</option>
        </select>
      </label>
      <button id="reset-data-btn" class="danger" style="width:100%; margin-top:2px;">Reset Data</button>
      <div id="reset-status" class="small muted" style="margin-top:8px; display:none;"></div>
    </div>
  <section class="card fade-in" style="margin-top:1.3rem;">
    <div class="section-hint">Expenses</div>
    <h2 style="margin-top:0; font-size:1.05rem;">Untagged Expenses</h2>
    <p class="small muted">Only expenses not yet included in any report (tagged = 0) are shown here.</p>
    <div class="table-wrap"><div class="table-responsive">
    <table id="expenses-table" class="table">
      <thead>
        <tr>
          <th>ID</th><th>Date</th><th>Category</th><th>Merchant</th><th>Amount</th><th>Payment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table></div></div>
  </section>
  <section id="links-section" class="card fade-in">
    <div class="section-hint">Links</div>
    <h2 style="margin-top:0; font-size:1.05rem;">Existing Expense ‚Üî Receipt Links</h2>
    <p class="small muted">Current stored matches for expenses that are still untagged. Once tagged, they disappear from this list.</p>
    <div class="toolbar" style="margin-bottom:.4rem;">
      <button id="create-report-from-links-btn" class="primary">Create Report From Selected Links</button>
    </div>
    <div class="table-wrap"><div class="table-responsive">
    <table id="links-table" class="table">
      <thead>
        <tr>
          <th>Select</th>
          <th>Expense ID</th>
          <th>Expense Merchant</th>
          <th>Expense Date</th>
          <th>Receipt ID</th>
          <th>Receipt File</th>
          <th>Receipt Merchant</th>
          <th>Receipt Amount</th>
          <th>Receipt Date</th>
          <th>Match Score</th>
        </tr>
      </thead>
      <tbody></tbody></table></div></div>
  </section>
  <section class="card fade-in">
    <div class="section-hint">Upload</div>
    <h2 style="margin-top:0; font-size:1.05rem;">Upload Receipts</h2>
    <form id="upload-form" class="toolbar" style="margin:.4rem 0 0;">
      <input type="file" id="files" name="files" multiple style="max-width:320px;" />
      <button type="submit" class="primary">Upload</button>
      <div class="spacer"></div>
      <div id="progress-label" class="small muted" style="display:none;">Processing invoices / receipts...</div>
    </form>
    <div id="progress-bar" style="display:none; width:100%; margin:10px 0 4px; background: var(--color-bg-alt); border:1px solid var(--color-border); border-radius: var(--radius-sm); height:12px; overflow:hidden;">
      <div class="progress-indeterminate" style="background: var(--gradient-accent); height:100%; width:100%;"></div>
    </div>
  </section>
  <section class="card fade-in matches">
    <div class="section-hint">Matching</div>
    <h2 style="margin-top:0; font-size:1.05rem;">Proposed Matches</h2>
    <div id="proposals" class="table-wrap" style="min-height:40px;"></div>
    <div class="toolbar" style="margin-top:.6rem;">
      <button id="confirm-btn" class="primary" style="display:none;">Confirm Matches</button>
      <button id="create-report-btn" class="primary" style="display:none;">Create Expense Report</button>
    </div>
  </section>
  <!-- Expense Report Modal -->
  <div id="report-modal" class="modal-backdrop" style="display:none;">
    <div class="modal-panel fade-in">
      <h3 style="margin-top:0; font-size:1rem;">New Expense Report</h3>
      <form id="report-form" class="flex-col gap-sm">
        <label class="small">Name
          <input required name="name" />
        </label>
        <label class="small">Interim Approver
          <input name="interim_approver" />
        </label>
        <label class="small">Approving Manager
          <input name="approving_manager" />
        </label>
        <label class="small">Purpose
          <textarea name="purpose" rows="3"></textarea>
        </label>
        <div class="small muted">Selected expenses & receipts are listed below and will be included.</div>
        <div id="selected-summary" style="max-height:140px; overflow:auto; border:1px solid var(--color-border); padding:6px 8px; font-size:.65rem; background: var(--color-bg-alt); border-radius: var(--radius-sm);"></div>
        <div class="toolbar" style="justify-content:flex-end; margin-top:.2rem;">
          <button type="button" id="cancel-report-btn">Cancel</button>
          <button type="submit" class="primary">Save Report</button>
        </div>
      </form>
    </div>
  </div>
  <footer class="app-footer">Built with FastAPI + Vanilla JS UI ‚Ä¢ <span id="year"></span></footer>
  </div>
  <script>
  const __origin = window.location.origin;
  const API_BASE = (__origin && __origin !== 'null') ? __origin : 'http://localhost:8000';
    // Theme toggle persistence
    const rootBody = document.body;
    const savedTheme = localStorage.getItem('app-theme');
    if(savedTheme){ rootBody.setAttribute('data-theme', savedTheme); }
    function toggleTheme(){
      const cur = rootBody.getAttribute('data-theme')==='dark' ? 'light':'dark';
      if(cur==='light') rootBody.removeAttribute('data-theme'); else rootBody.setAttribute('data-theme','dark');
      localStorage.setItem('app-theme', cur==='light'? '' : 'dark');
    }
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('year').textContent = new Date().getFullYear();

    async function loadExpenses(){
      const res = await fetch(`${API_BASE}/expenses/?tagged=0`);
      const data = await res.json();
      const tbody = document.querySelector('#expenses-table tbody');
      tbody.innerHTML='';
      data.forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.id}</td><td>${e.date}</td><td>${e.category}</td><td>${e.merchant}</td><td>${e.amount}</td><td>${e.payment_method}</td>`;
        tbody.appendChild(tr);
      });
      window._expenses = data;
    }

    async function loadLinks(){
      const res = await fetch(`${API_BASE}/expenses/receipt-links?tagged=0`);
      if(!res.ok){ return; }
      const data = await res.json();
      const tbody = document.querySelector('#links-table tbody');
      tbody.innerHTML='';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type='checkbox' class='link-select' data-expense-id='${row.expense_id}' data-receipt-id='${row.receipt_id}' data-receipt-file='${row.original_filename || ''}'></td>
          <td>${row.expense_id}</td>
          <td>${row.expense_merchant||''}</td>
          <td>${row.expense_date||''}</td>
          <td>${row.receipt_id}</td>
          <td>${row.original_filename||''}</td>
          <td>${row.receipt_merchant||''}</td>
          <td>${row.receipt_amount||''}</td>
          <td>${row.receipt_date||''}</td>
          <td>${row.match_score!=null? (Math.round(row.match_score*100)/100): ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function scoreClass(score){
      if(score >= 0.75) return 'score-high';
      if(score >= 0.45) return 'score-mid';
      return 'score-low';
    }

    function renderProposals(receipts, proposals){
      const container = document.getElementById('proposals');
      container.innerHTML='';
      const mapByReceipt = {};
      proposals.forEach(p=>{ mapByReceipt[p.receipt_id]=p; });
      if(!receipts.length){
        document.getElementById('confirm-btn').style.display='none';
        document.getElementById('create-report-btn').style.display='none';
        return;
      }
      const table = document.createElement('table');
      table.id = 'matches-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Select</th>
            <th>Invoice Name</th>
            <th>Fields Extracted from Invoice</th>
            <th>Match Score (0 to 1). Higher is better</th>
            <th>Mapped Expense - ID, Merchant, Amount, Date</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      receipts.forEach(r=>{
        const p = mapByReceipt[r.id];
        const tr = document.createElement('tr');
        tr.className = p? scoreClass(p.score): '';
        const extracted = [
          r.extracted_merchant || r.extracted_vendor_name ? `Merchant: ${r.extracted_merchant || r.extracted_vendor_name}`: null,
          r.extracted_amount!=null ? `Amount: ${r.extracted_amount}`: null,
          r.extracted_date ? `Date: ${r.extracted_date}`: null,
          (r.extracted_service_start || r.extracted_service_end)? `Range: ${r.extracted_service_start||'?'} - ${r.extracted_service_end||'?'}`: null
        ].filter(Boolean).join('<br>');
        const canSelect = !(r.error_message || (r.status && r.status.startsWith('error_')));
        let selectHtml = '';
        if(canSelect){
          const options = window._expenses.map(e=>`<option value="${e.id}" ${p && p.expense_id===e.id? 'selected':''}>#${e.id} ${e.merchant} (${e.amount}) ${e.date}</option>`).join('');
          selectHtml = `<select class='match-expense-select' data-receipt-id='${r.id}'>${options}</select>`;
        } else {
          selectHtml = '<em>n/a</em>';
        }
        const scoreCell = p? `${p.score}<br><span style='font-size:11px;color:#555;'>${p.rationale}</span>` : (r.error_message? `<span class='err'>${r.error_message}</span>`:'');
        tr.innerHTML = `
          <td><input type='checkbox' class='report-expense-checkbox' data-receipt-id='${r.id}' ${!canSelect? 'disabled':''} data-expense-id='${p? p.expense_id: ''}'></td>
          <td>${r.original_filename}</td>
          <td style='font-size:12px;'>${extracted || '<em>None</em>'}</td>
          <td>${scoreCell}</td>
          <td>${selectHtml}</td>`;
        tbody.appendChild(tr);
      });
      container.appendChild(table);
      document.getElementById('confirm-btn').style.display='inline-block';
      document.getElementById('create-report-btn').style.display='inline-block';
    }

    document.getElementById('upload-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      document.getElementById('progress-bar').style.display = 'block';
      document.getElementById('progress-label').style.display = 'block';
      const fd = new FormData();
      const files = document.getElementById('files').files;
      for(const f of files){ fd.append('files', f); }
      const provider = document.getElementById('provider').value;
      try {
        const res = await fetch(`${API_BASE}/receipts/upload?provider=${encodeURIComponent(provider)}`, { method:'POST', body: fd });
        const data = await res.json();
        window._receipts = data.receipts;
        window._proposals = data.proposals;
        renderProposals(data.receipts, data.proposals);
      } finally {
        document.getElementById('progress-bar').style.display = 'none';
        document.getElementById('progress-label').style.display = 'none';
      }
    });

    document.getElementById('confirm-btn').addEventListener('click', async ()=>{
      const selects = document.querySelectorAll('#proposals select');
      const mappings = [];
      selects.forEach(sel=>{
        const recId = parseInt(sel.dataset.receiptId,10);
        const expId = parseInt(sel.value,10);
        const existing = (window._proposals||[]).find(p=>p.receipt_id===recId && p.expense_id===expId);
        mappings.push({ receipt_id: recId, expense_id: expId, score: existing? existing.score : 0.0, rationale: existing? existing.rationale: 'manual' });
      });
      await fetch(`${API_BASE}/receipts/confirm-matches`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mappings }) });
      alert('Matches confirmed');
      loadLinks();
    });

    // Report creation flow
    const reportModal = document.getElementById('report-modal');
    const createReportBtn = document.getElementById('create-report-btn');
  const createReportFromLinksBtn = document.getElementById('create-report-from-links-btn');
    const selectedSummary = document.getElementById('selected-summary');
    createReportBtn.addEventListener('click', () => {
      // Aggregate selected expenses (via checkboxes) and associated receipts
      const rows = Array.from(document.querySelectorAll('#matches-table tbody tr'));
      const expenseIds = new Set();
      const receiptIds = new Set();
      const lines = [];
      rows.forEach(r => {
        const cb = r.querySelector('.report-expense-checkbox');
        if(cb && cb.checked){
          const receiptId = cb.getAttribute('data-receipt-id');
            const select = r.querySelector('select.match-expense-select');
            const expenseId = select? select.value : cb.getAttribute('data-expense-id');
            if(expenseId) expenseIds.add(expenseId);
            if(receiptId) receiptIds.add(receiptId);
            const fileName = r.children[1].textContent;
            lines.push(`#${expenseId || '?'} <- ${fileName}`);
        }
      });
      if(!lines.length){
        alert('Select at least one mapped row to include in a report.');
        return;
      }
      selectedSummary.innerHTML = lines.join('<br>');
      reportModal.style.display='flex';
      reportModal.dataset.expenseIds = JSON.stringify(Array.from(expenseIds));
      reportModal.dataset.receiptIds = JSON.stringify(Array.from(receiptIds));
    });
    document.getElementById('cancel-report-btn').addEventListener('click', ()=>{
      reportModal.style.display='none';
    });
    document.getElementById('report-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(e.target);
      const payload = {
        name: formData.get('name'),
        interim_approver: formData.get('interim_approver') || null,
        approving_manager: formData.get('approving_manager') || null,
        purpose: formData.get('purpose') || null,
        expense_ids: JSON.parse(reportModal.dataset.expenseIds || '[]').map(x=>parseInt(x,10)),
        receipt_ids: JSON.parse(reportModal.dataset.receiptIds || '[]').map(x=>parseInt(x,10))
      };
      const res = await fetch(`${API_BASE}/expense-reports/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if(!res.ok){
        const err = await res.text();
        alert('Failed to create report: '+ err);
        return;
      }
      const data = await res.json();
      alert('Report created with id '+ data.id);
      reportModal.style.display='none';
      e.target.reset();
      await loadExpenses();
      await loadLinks();
      window.open(`report-detail.html?id=${data.id}`, '_blank');
    });

    // Create report from selected existing links
    createReportFromLinksBtn.addEventListener('click', ()=>{
      const checked = Array.from(document.querySelectorAll('.link-select:checked'));
      if(!checked.length){
        alert('Select at least one link row first.');
        return;
      }
      const expenseIds = new Set();
      const receiptIds = new Set();
      const lines = [];
      checked.forEach(cb => {
        const expId = cb.getAttribute('data-expense-id');
        const recId = cb.getAttribute('data-receipt-id');
        const file = cb.getAttribute('data-receipt-file') || '(receipt)';
        if(expId) expenseIds.add(expId);
        if(recId) receiptIds.add(recId);
        lines.push(`#${expId} <- ${file}`);
      });
      selectedSummary.innerHTML = lines.join('<br>');
      reportModal.style.display='flex';
      reportModal.dataset.expenseIds = JSON.stringify(Array.from(expenseIds));
      reportModal.dataset.receiptIds = JSON.stringify(Array.from(receiptIds));
    });

    document.addEventListener('click', e => {
      if(e.target.classList.contains('dbg-toggle')){
        const id = e.target.getAttribute('data-target');
        const pre = document.getElementById(id);
        if(pre){ pre.style.display = pre.style.display === 'none' ? 'block':'none'; }
      }
    });

    async function initialLoad(){
      await loadExpenses();
      await loadLinks();
    }
    initialLoad();

    // Settings panel toggle
    const settingsToggle = document.getElementById('settings-toggle');
    const settingsPanel = document.getElementById('settings-panel');
    settingsToggle.addEventListener('click', ()=>{
      settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block':'none';
    });
    document.addEventListener('click', (e)=>{
      if(!settingsPanel.contains(e.target) && e.target !== settingsToggle){
        // do not auto-close if clicking inside panel
        if(settingsPanel.style.display==='block'){
          // keep open if interacting with form controls
          if(['SELECT','BUTTON'].includes(e.target.tagName)) return;
          // optional auto-close omitted for now
        }
      }
    });

    // Reset data handler
    const resetBtn = document.getElementById('reset-data-btn');
    const resetStatus = document.getElementById('reset-status');
    resetBtn.addEventListener('click', async ()=>{
      if(!confirm('This will delete all receipts, matches, reports and custom expenses, restoring only original seed expenses. Continue?')) return;
      resetBtn.disabled = true;
      resetStatus.style.display='block';
      resetStatus.style.color='#555';
      resetStatus.textContent='Resetting...';
      try {
        const res = await fetch(`${API_BASE}/admin/reset-data`, { method:'POST' });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();
        resetStatus.style.color='#0a6b00';
        resetStatus.textContent='Reset complete';
        // Clear UI state
        document.getElementById('proposals').innerHTML='';
        document.getElementById('confirm-btn').style.display='none';
        document.getElementById('create-report-btn').style.display='none';
        await loadExpenses();
        await loadLinks();
      } catch(err){
        resetStatus.style.color='#b30000';
        resetStatus.textContent='Reset failed: '+ err;
      } finally {
        resetBtn.disabled = false;
        setTimeout(()=>{ resetStatus.style.display='none'; }, 4000);
      }
    });
  </script>
</body>
</html>
